<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Fish Feeder Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* KEEP ALL YOUR EXISTING CSS - PERFECT! */
        :root { --blue-bg: #2575fc; --blue-dark: #1259a0; --green: #2e7d32; --red: #e53935; --orange: #ff7043; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; min-height: 100%; font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #6a11cb 0%, var(--blue-bg) 100%); color: #fff; }
        /* ... YOUR CSS IS PERFECT - NO CHANGES NEEDED ... */
    </style>
</head>
<body>
<div class="page-wrap">
    <div class="top-bar">
        <a class="logout-btn" href="{{ url_for('logout') }}">Logout</a>
    </div>

    <div class="container">
        <h1>üêü Smart Fish Feeder Dashboard v3.0</h1>

        <div class="top-buttons">
            <a class="btn btn-pdf" href="{{ url_for('exportpdf') }}">üì• Download PDF</a>
            <button id="btnRefresh" class="btn btn-refresh" type="button">üîÑ Refresh</button>
        </div>

        <!-- WATER QUALITY STATUS -->
        <div class="summary" id="summaryBox" style="background-color: green;">
            Loading water quality...
        </div>

        <!-- LIVE SENSOR READINGS -->
        <h2>üìä Live Sensor Data</h2>
        <div class="status-box" id="liveSensors">
            Ammonia: <span id="live-ammonia">--</span>ppm | 
            Turbidity: <span id="live-turbidity">--</span>NTU | 
            Hopper: <span id="live-hopper">OK</span>
        </div>

        <!-- FEEDER CONTROL -->
        <div class="control-section">
            <h2 style="text-align: center;">üçΩÔ∏è Feeder Control (ESP32001)</h2>
            
            <div class="control-buttons">
                <button class="btn-control-on" onclick="feederControl('on', 70)">‚ñ∂Ô∏è FEED ON (70%)</button>
                <button class="btn-control-off" onclick="feederControl('off')">‚èπÔ∏è FEED OFF</button>
            </div>

            <div class="speed-control">
                <label>Speed: <span id="speed-display">50</span>%</label>
                <input type="range" class="speed-slider" id="speed-slider" min="20" max="100" value="70">
                <button class="btn-set" onclick="setFeederSpeed()">‚ö° Set Speed</button>
            </div>

            <div class="status-box">
                Status: <span id="feeder-status">OFF</span> | 
                Speed: <span id="feeder-speed">0</span>%
            </div>
        </div>

        <!-- SENSOR CHART -->
        <h2>üìà Sensor Trends (Last 20 readings)</h2>
        <div class="chart-wrapper">
            <canvas id="sensorChart" height="200"></canvas>
        </div>

        <!-- SENSOR TABLE -->
        <h2>üìã Latest Readings</h2>
        <div class="table-wrapper">
            <table id="sensorTable">
                <thead>
                    <tr><th>Time</th><th>Temp (¬∞C)</th><th>pH</th><th>NH‚ÇÉ (ppm)</th><th>Turbidity (NTU)</th><th>Feeder</th></tr>
                </thead>
                <tbody id="sensorTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let sensorChart;

    // üî• FIXED API FUNCTIONS - MATCH NEW PYTHON ROUTES
    async function apiCall(endpoint, options = {}) {
        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('API Error:', endpoint, error);
            return null;
        }
    }

    // LIVE STATUS UPDATE (Every 3 seconds)
    async function updateLiveStatus() {
        const data = await apiCall('/status');
        if (!data) return;

        // Update live sensors
        document.getElementById('live-ammonia').textContent = 
            data.latest?.ammonia?.toFixed(2) || '--';
        document.getElementById('live-turbidity').textContent = 
            data.latest?.turbidity?.toFixed(0) || '--';
        document.getElementById('live-hopper').textContent = 
            data.latest?.limit_switch || 'OK';
        
        // Water quality summary
        const summaryBox = document.getElementById('summaryBox');
        const ammonia = data.latest?.ammonia || 0;
        const turbidity = data.latest?.turbidity || 0;
        
        if (ammonia > 2 || turbidity > 100) {
            summaryBox.textContent = 'üö® WATER QUALITY ALERT!';
            summaryBox.style.backgroundColor = '#e53935';
        } else if (turbidity > 50) {
            summaryBox.textContent = '‚ö†Ô∏è Check water clarity';
            summaryBox.style.backgroundColor = '#ff7043';
        } else {
            summaryBox.textContent = '‚úÖ All systems normal';
            summaryBox.style.backgroundColor = '#2e7d32';
        }
    }

    // FEEDER CONTROL
    async function feederControl(action, speed = 0) {
        const data = await apiCall('/controlfeeding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ action: action, speed: speed })
        });
        
        if (data) {
            alert(action === 'on' ? `‚úÖ Feeder ON (${speed}%)` : '‚úÖ Feeder OFF');
            updateFeederStatus();
        }
    }

    function setFeederSpeed() {
        const speed = document.getElementById('speed-slider').value;
        feederControl('on', speed);
    }

    // FEEDER STATUS
    async function updateFeederStatus() {
        const data = await apiCall('/api/feederstatus');
        if (!data) return;
        
        document.getElementById('feeder-speed').textContent = data.feederspeed || 0;
        const statusEl = document.getElementById('feeder-status');
        statusEl.textContent = data.feederstatus?.toUpperCase() || 'OFF';
        statusEl.style.color = data.feederstatus === 'on' ? '#28a745' : '#dc3545';
    }

    // UPDATE SENSOR TABLE
    async function updateSensorTable() {
        const data = await apiCall('/api/latest');
        if (!data || !data.readings) return;

        const tbody = document.getElementById('sensorTableBody');
        tbody.innerHTML = '';

        data.readings.slice(-10).forEach(reading => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${reading.timestamp?.slice(11, 16) || '--'}</td>
                <td>${reading.temperature?.toFixed(1) || '--'}</td>
                <td>${reading.ph?.toFixed(1) || '--'}</td>
                <td>${reading.ammonia?.toFixed(2) || '--'}</td>
                <td>${reading.turbidity?.toFixed(0) || '--'}</td>
                <td>${reading.feeder_status || 'OFF'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // CHART SETUP
    function initChart() {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Temperature (¬∞C)', data: [], borderColor: '#ff7043', backgroundColor: 'rgba(255,112,67,0.1)', tension: 0.4 },
                    { label: 'pH', data: [], borderColor: '#42a5f5', backgroundColor: 'rgba(66,165,245,0.1)', tension: 0.4 },
                    { label: 'Ammonia (ppm)', data: [], borderColor: '#66bb6a', backgroundColor: 'rgba(102,187,106,0.1)', tension: 0.4 },
                    { label: 'Turbidity (NTU)', data: [], borderColor: '#ffca28', backgroundColor: 'rgba(255,202,40,0.1)', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { x: { title: { display: true, text: 'Time' } } }
            }
        });
    }

    // UPDATE CHART
    async function updateChart() {
        const data = await apiCall('/api/latest');
        if (!data || !data.readings) return;

        const readings = data.readings.slice(-20);
        sensorChart.data.labels = readings.map(r => r.timestamp?.slice(11, 16) || '');
        sensorChart.data.datasets[0].data = readings.map(r => r.temperature || 0);
        sensorChart.data.datasets[1].data = readings.map(r => r.ph || 0);
        sensorChart.data.datasets[2].data = readings.map(r => r.ammonia || 0);
        sensorChart.data.datasets[3].data = readings.map(r => r.turbidity || 0);
        sensorChart.update('none');
    }

    // MAIN UPDATE LOOP
    async function mainUpdate() {
        await Promise.all([
            updateLiveStatus(),
            updateFeederStatus(),
            updateSensorTable(),
            updateChart()
        ]);
    }

    // STARTUP
    window.addEventListener('load', () => {
        initChart();
        mainUpdate();
        document.getElementById('btnRefresh').onclick = mainUpdate;
    });

    // AUTO-REFRESH EVERY 3 SECONDS
    setInterval(mainUpdate, 3000);
</script>
</body>
</html>
