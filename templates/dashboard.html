<!DOCTYPE html>
<html>
<head>
    <!-- Firebase App (core SDK) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<!-- Firebase Cloud Messaging -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging.js"></script>
<!-- Firebase Analytics -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js"></script>

<script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCrla5u2TdlL_86uVy6YSgBYEUoECpseIc",
        authDomain: "fish-feeder-54bdb.firebaseapp.com",
        projectId: "fish-feeder-54bdb",
        storageBucket: "fish-feeder-54bdb.firebasestorage.app",
        messagingSenderId: "222985021447",
        appId: "1:222985021447:web:0953b0c7c959e2a5f9e2a2",
        measurementId: "G-JRNQ54VMMQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // Initialize Firebase Messaging
    const messaging = firebase.messaging();

    // Request permission and get token
    async function requestPermission() {
        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                const token = await messaging.getToken({
                    vapidKey: 'BFgQTvgkqwXMPLrypgQxGEH41C4jrEmn8CDXNjZ5lJ9G6tW4GBednpQ5033ZzM6Q2HZCkCBCy1fKL0Iuam3xIJk'
                });
                console.log("‚úÖ Token received:", token);
                // Send token to server for storage
                fetch('/send_notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        title: 'Test Notification',
                        body: 'Firebase notifications are working!'
                    })
                })
                .then(res => res.json())
                .then(data => console.log('Notification sent:', data))
                .catch(err => console.error('Error sending notification:', err));
            } else {
                console.log('‚ùå Permission denied for notifications.');
            }
        } catch (error) {
            console.error('Error getting permission or token:', error);
        }
    }

    requestPermission();
</script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Fish Feeder Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chart-container {
            width: 100%;
            max-width: 100%;
            height: 400px;
            margin: 0 auto 32px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 20px;
            transition: transform 0.3s ease;
        }
        .chart-container:hover {
            transform: translateY(-5px);
        }
        #sensorChart {
            width: 100% !important;
            height: 100% !important;
        }
        .alert-card {
            padding: 20px;
            margin-bottom: 24px;
            border-radius: 12px;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            letter-spacing: 0.5px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 32px;
            background: #fff;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow-x: auto;
        }
        .data-table th, .data-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: #fff;
            font-weight: 600;
        }
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .data-table tr:hover {
            background: #e3f2fd;
            transition: background 0.3s ease;
        }
        header {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: #fff;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 24px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        footer {
            text-align: center;
            color: #fff;
            padding: 20px 0;
            margin-top: 32px;
        }
        h1, h2 {
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        h2 {
            text-align: center;
            margin-top: 24px;
            margin-bottom: 16px;
            color: #fff;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: #43a047;
            color: #fff;
        }
        .btn-danger {
            background: #e53935;
            color: #fff;
        }
        .btn-secondary {
            background: #1976d2;
            color: #fff;
        }
        .btn-info {
            background: #00acc1;
            color: #fff;
        }
        .historical-section {
            display: none;
            margin-top: 32px;
        }
        .historical-section.show {
            display: block;
        }
        .historical-table {
            max-height: 400px;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .chart-container {
                height: 300px;
                padding: 10px;
            }
            .data-table th, .data-table td {
                padding: 8px 4px;
                font-size: 0.9em;
            }
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                width: 100%;
                max-width: 200px;
            }
            h2 {
                font-size: 1.2em;
            }
        }
        @media (max-width: 480px) {
            header {
                padding: 15px 0;
            }
            h1 {
                font-size: 1.5em;
            }
            .alert-card {
                font-size: 1em;
                padding: 15px;
            }
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üêü Smart Fish Feeder Dashboard</h1>
    </header>

    <div class="container">
        <div style="text-align: right; margin-bottom: 16px;">
            <button type="button" class="btn btn-info" onclick="loadHistoricalData()">üìä View Historical Data</button>
            <form method="get" style="display: inline;">
                <button type="submit" class="btn btn-secondary">üîÑ Refresh</button>
            </form>
        </div>

        {% if summary %}
        <div class="alert-card" style="background: {{ alert_color }};">
            {{ summary }}
        </div>
        {% endif %}

        <h2>Latest Sensor Readings (Last 10)</h2>
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Temperature (¬∞C)</th>
                        <th>pH</th>
                        <th>Ammonia (ppm)</th>
                        <th>Turbidity (NTU)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in readings %}
                    {% set alerts = [] %}
                    {% set color = "" %}
                    {% if r.temperature > 30 or r.temperature < 20 %}
                        {% set _ = alerts.append("‚ö†Ô∏è Temp Alert") %}
                    {% endif %}
                    {% if r.ph < 6.5 or r.ph > 8.5 %}
                        {% set _ = alerts.append("‚ö†Ô∏è pH Alert") %}
                    {% endif %}
                    {% if r.ammonia > 0.5 %}
                        {% set _ = alerts.append("‚ùå High Ammonia") %}
                    {% endif %}
                    {% if r.turbidity > 50 %}
                        {% set _ = alerts.append("‚ö†Ô∏è High Turbidity") %}
                    {% endif %}
                    {% if alerts %}
                        {% set status = alerts | join(', ') %}
                        {% set color = "background-color:#ffe0b3;" %}
                    {% else %}
                        {% set status = "Normal" %}
                        {% set color = "" %}
                    {% endif %}
                    <tr style="{{ color }}">
                        <td>{{ r.createdAt }}</td>
                        <td>{{ r.temperature }}</td>
                        <td>{{ r.ph }}</td>
                        <td>{{ r.ammonia }}</td>
                        <td>{{ r.turbidity }}</td>
                        <td>{{ status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2>Sensor Trends</h2>
        <div class="chart-container">
            <canvas id="sensorChart"></canvas>
        </div>

        <div class="button-group">
            <form id="manualFeedForm">
                <button type="submit" name="action" value="on" class="btn btn-primary">Manual Feed ON</button>
                <button type="submit" name="action" value="off" class="btn btn-danger">Manual Feed OFF</button>
            </form>
            <form id="autoFeedForm">
                <button type="submit" class="btn btn-secondary">Set Automatic Feeding<br>9:00 AM & 4:00 PM</button>
            </form>
        </div>

        <div id="historicalSection" class="historical-section">
            <h2>Historical Sensor Data</h2>
            <div class="historical-table">
                <table class="data-table" id="historicalTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Temperature (¬∞C)</th>
                            <th>pH</th>
                            <th>Ammonia (ppm)</th>
                            <th>Turbidity (NTU)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historicalTableBody">
                        <!-- Historical data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <small>&copy; 2025 Smart Fish Feeder</small>
    </footer>

    <script>
        const labels = {{ readings | map(attribute='createdAt') | list | safe }};
        const tempData = {{ readings | map(attribute='temperature') | list | safe }};
        const phData = {{ readings | map(attribute='ph') | list | safe }};
        const ammoniaData = {{ readings | map(attribute='ammonia') | list | safe }};
        const turbidityData = {{ readings | map(attribute='turbidity') | list | safe }};

        const data = {
            labels: labels,
            datasets: [
                { label: 'Temperature (¬∞C)', data: tempData, borderColor: '#ff5722', backgroundColor: 'rgba(255, 87, 34, 0.1)', fill: false, tension: 0.4 },
                { label: 'pH', data: phData, borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.1)', fill: false, tension: 0.4 },
                { label: 'Ammonia (ppm)', data: ammoniaData, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: false, tension: 0.4 },
                { label: 'Turbidity (NTU)', data: turbidityData, borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', fill: false, tension: 0.4 },
            ]
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x',
                        },
                        zoom: {
                            enabled: true,
                            mode: 'x',
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#fff',
                        borderWidth: 1,
                    },
                    legend: {
                        display: true,
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            },
            plugins: [ChartZoom]
        };

        new Chart(document.getElementById('sensorChart'), config);

        function loadHistoricalData() {
            const historicalSection = document.getElementById('historicalSection');
            const tableBody = document.getElementById('historicalTableBody');

            if (historicalSection.classList.contains('show')) {
                historicalSection.classList.remove('show');
                return;
            }

            fetch('/historical')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        tableBody.innerHTML = '';
                        data.readings.forEach(reading => {
                            let alerts = [];
                            if (reading.temperature > 30 || reading.temperature < 20) alerts.push("‚ö†Ô∏è Temp Alert");
                            if (reading.ph < 6.5 || reading.ph > 8.5) alerts.push("‚ö†Ô∏è pH Alert");
                            if (reading.ammonia > 0.5) alerts.push("‚ùå High Ammonia");
                            if (reading.turbidity > 50) alerts.push("‚ö†Ô∏è High Turbidity");
                            const status = alerts.length > 0 ? alerts.join(', ') : "Normal";
                            const color = alerts.length > 0 ? "background-color:#ffe0b3;" : "";

                            const row = document.createElement('tr');
                            row.style = color;
                            row.innerHTML = `
                                <td>${reading.createdAt}</td>
                                <td>${reading.temperature}</td>
                                <td>${reading.ph}</td>
                                <td>${reading.ammonia}</td>
                                <td>${reading.turbidity}</td>
                                <td>${status}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                        historicalSection.classList.add('show');
                    } else {
                        alert('Error loading historical data: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading historical data');
                });
        }

        document.getElementById('manualFeedForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.activeElement;
            const action = btn.value;
            fetch('/feed/manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=' + encodeURIComponent(action)
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
            });
        });

        document.getElementById('autoFeedForm').addEventListener('submit', function(e) {
            e.preventDefault();
            fetch('/feed/schedule', {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
            });
        });
    </script>
</body>
</html>
